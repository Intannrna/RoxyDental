services:
  # --- Frontend ---
  frontend:
    container_name: roxy-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    restart: always
    env_file: .env.prod
    environment:
      # <--- TAMBAHKAN INI
      - PORT=3000 # <--- INI PENTING: Paksa balik ke 3000
    networks:
      - roxy-network

  # --- Backend ---
  backend:
    container_name: roxy-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    env_file: .env.prod
    environment:
      DATABASE_URL: ${DATABASE_URL}
      DIRECT_URL: ${DIRECT_URL}
      PORT: 5000
      JWT_SECRET: ${JWT_SECRET}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
    networks:
      - roxy-network

  # --- AI Service ---
  # --- AI Service ---
  ai:
    container_name: roxy-ai
    build:
      context: ./roxydental-ai
      dockerfile: Dockerfile
    restart: always
    env_file: .env.prod
    environment:
      # Ini sudah benar pakai DIRECT_URL biar Python ga bingung
      DATABASE_URL: postgresql://postgres.tazhmefhxudykusfzigz:a84594325B.@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres
      GEMINI_API_KEY: ${GEMINI_API_KEY}

    # ðŸ‘‡ TAMBAHKAN BAGIAN INI (Wajib sejajar dengan environment)
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
      - net.ipv6.conf.default.disable_ipv6=1
    # ðŸ‘† SAMPAI SINI

    networks:
      - roxy-network

  # --- Nginx ---
  nginx:
    image: nginx:alpine
    container_name: roxy-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - frontend
      - backend
      - ai
    networks:
      - roxy-network

  # --- Certbot ---
  certbot:
    image: certbot/certbot
    container_name: roxy-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    networks:
      - roxy-network

networks:
  roxy-network:
    driver: bridge
